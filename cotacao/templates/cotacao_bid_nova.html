{% extends 'base.html' %}
{% load static %}

{% block title %}Nova Cotação BID{% endblock %}

{% block content %}

    <h3 class="mb-4 text-dark">Iniciar Nova Cotação BID</h3>

    <div class="card shadow mb-4">
        
        <div class="card-header py-3 bg-primary text-white">
            <h6 class="m-0 fw-bold">Passo 1: Seleção Inicial</h6>
        </div>
        
        {% if antt_vazio %}
            <div class="card-body bg-light border-bottom border-danger p-3"> 
                <form method="POST" action="{% url 'inicializar_tabelas_antt' %}" class="mb-0">
                    {% csrf_token %}
                    <div class="alert alert-danger mb-0 text-center" role="alert">
                        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i> Atenção!</h5>
                        <p class="mb-2">A tabela de Frete Mínimo ANTT está vazia. É necessário inicializar os dados padrões.</p>
                        
                        <button type="submit" class="btn btn-danger btn-lg w-75 mt-2">
                            <i class="bi bi-database-fill-add me-2"></i> Cadastrar Tabelas ANTT Padrão
                        </button>
                    </div>
                </form>
            </div>
        {% endif %}

        <div class="card-body">
            <form method="POST" action="{% url 'proxima_etapa_bid' %}">
                {% csrf_token %}
                

    <div class="card-body">
        <form method="POST" action="{% url 'proxima_etapa_bid' %}">
            {% csrf_token %}
            
            <div class="row g-4">
                
                <div class="col-md-6">
                    <label for="search_term" class="form-label fw-bold">Buscar Cliente (Nome ou CNPJ)</label>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="search_term" 
                            placeholder="Digite para buscar e selecionar o cliente..."
                            onkeyup="searchClients()">
                        
                        <a href="{%url 'cadastro_cliente'%}" class="btn btn-outline-success" type="button">
                            <i class="bi bi-person-add"></i> Cadastrar
                        </a>
                    </div>

                    <input type="hidden" name="cliente_id" id="cliente_id_hidden" required> 
                    
                    <p id="selected_client_display" class="fw-bold text-primary mb-0" style="min-height: 1.5rem;">
                        Cliente não selecionado.
                    </p>

                    <div id="client_results_container" class="mt-2" style="max-height: 300px; overflow-y: auto;">
                    </div>
                </div>
                
                <div class="col-md-6">
                    <label for="tabela_antt_input" class="form-label fw-bold">Tabela ANTT para Frete Mínimo</label>

                    <input type="text" 
                        class="form-control" 
                        id="tabela_antt_input"
                        name="tabela_antt_display" placeholder="Clique para ver ou digite para buscar a tabela ANTT..."
                        onkeyup="searchAntt()"
                        onfocus="searchAntt(true)" {% if antt_vazio %}disabled{% endif %}
                        required>
                    
                    <input type="hidden" name="tabela_antt_id" id="antt_id_hidden" required>

                    <p id="selected_antt_display" class="fw-bold text-primary mb-0" style="min-height: 1.5rem;">
                        Tabela ANTT não selecionada.
                    </p>
                    
                    <div id="antt_results_container" class="mt-2" style="max-height: 300px; overflow-y: auto;">
                    </div>
                </div>
                <div class="col-12 text-end pt-3">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-arrow-right-circle me-2"></i> Carregar e Prosseguir
                    </button>
                </div>
                
            </div>
        </form>
        </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ----------------------------------------------------
    // VARIÁVEIS DE CONTROLE
    // ----------------------------------------------------
    const CLIENT_SEARCH_URL = "{% url 'api_search_clients' %}"; 
    const ANTT_SEARCH_URL = "{% url 'api_search_antt' %}";
    
    let searchTimeout; // Debounce para Cliente
    let anttSearchTimeout; // Debounce para ANTT

    // Elementos ANTT (referenciam os novos IDs)
    const anttInput = document.getElementById('tabela_antt_input');
    const anttResultsContainer = document.getElementById('antt_results_container');
    const anttHiddenId = document.getElementById('antt_id_hidden');
    const anttDisplay = document.getElementById('selected_antt_display');


    // ----------------------------------------------------
    // 1. LÓGICA DE CLIENTE (MANTIDA IGUAL)
    // ----------------------------------------------------

    // Lógica de Busca de Clientes (Disparada ao digitar)
    function searchClients() {
        // Limpa o timeout anterior para evitar múltiplas chamadas rápidas
        clearTimeout(searchTimeout);
        
        const term = document.getElementById('search_term').value.trim();
        const resultsContainer = document.getElementById('client_results_container');
        const hiddenIdInput = document.getElementById('cliente_id_hidden');
        
        // Limpa a seleção anterior ao começar a digitar
        document.getElementById('selected_client_display').textContent = 'Cliente não selecionado.';
        hiddenIdInput.value = '';
        
        if (term.length < 3) {
            resultsContainer.innerHTML = '';
            return;
        }

        // Aguarda 300ms antes de buscar (debounce)
        searchTimeout = setTimeout(() => {
            
            // Exibe o loading
            resultsContainer.innerHTML = `<p class="text-info text-center">
                <i class="bi bi-arrow-clockwise spinner-border spinner-border-sm me-2"></i> Buscando...
            </p>`;

            // Faz a requisição AJAX para sua view Django
            fetch(`${CLIENT_SEARCH_URL}?q=${term}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data.length === 0) {
                        html = '<p class="text-danger text-center">Nenhum cliente encontrado.</p>';
                    } else {
                        // Constrói a tabela de resultados
                        html = `
                            <table class="table table-sm table-hover border">
                                <thead>
                                    <tr class="table-light">
                                        <th>Razão Social</th>
                                        <th>CNPJ</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        data.forEach(client => {
                            html += `
                                <tr>
                                    <td>${client.razaoSocial}</td>
                                    <td>${client.cnpj}</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="selectClient(${client.idCliente}, '${client.razaoSocial}', '${client.cnpj}')">
                                            Selecionar
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        html += `</tbody></table>`;
                    }
                    resultsContainer.innerHTML = html;
                })
                .catch(error => {
                    resultsContainer.innerHTML = '<p class="text-danger text-center">Erro ao buscar clientes.</p>';
                    console.error('Fetch error:', error);
                });

        }, 300);
    }
    
    // Lógica de Seleção (Chamada ao clicar em "Selecionar")
    function selectClient(id, razaoSocial, cnpj) {
        //debugger
        console.log(id, razaoSocial);
        const hiddenIdInput = document.getElementById('cliente_id_hidden');
        
        // 1. Preenche o campo hidden com o ID (para submissão do form)
        hiddenIdInput.value = id;
        
        hiddenIdInput.dispatchEvent(new Event('change')); 
        
        // 2. Preenche o campo de exibição
        document.getElementById('selected_client_display').textContent = `Cliente Selecionado: ${razaoSocial} | CNPJ: ${cnpj}`;
        
        // 3. Limpa a área de busca/resultados
        document.getElementById('search_term').value = razaoSocial; 
        document.getElementById('client_results_container').innerHTML = '';
    }


    // ----------------------------------------------------
    // 2. LÓGICA DA TABELA ANTT
    // ----------------------------------------------------

    // Lógica de Busca de Tabelas ANTT (Disparada por input ou focus)
    function searchAntt(isFocus = false) {
        clearTimeout(anttSearchTimeout);

        const term = anttInput.value.trim();
        // Se não for um evento de clique (focus) E o termo for muito curto, limpa e sai.
        // Se for foco (isFocus=true) e não houver termo, buscamos todas (finalTerm = '')
        if (!isFocus && term.length < 2) {
            anttResultsContainer.innerHTML = '';
            return;
        }
        
        // Limpa a seleção anterior
        anttDisplay.textContent = 'Tabela ANTT não selecionada.';
        anttHiddenId.value = '';

        // Define o termo de busca para vazio se for apenas foco no campo
        const finalTerm = isFocus ? '' : term;

        anttSearchTimeout = setTimeout(() => {
            
            anttResultsContainer.innerHTML = `<p class="text-info text-center">
                <i class="bi bi-arrow-clockwise spinner-border spinner-border-sm me-2"></i> Buscando...
            </p>`;

            fetch(`${ANTT_SEARCH_URL}?q=${finalTerm}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data.length === 0) {
                        html = '<p class="text-danger text-center">Nenhuma tabela ANTT encontrada.</p>';
                    } else {
                        html = `
                            <table class="table table-sm table-hover border">
                                <thead>
                                    <tr class="table-light">
                                        <th>Código</th>
                                        <th>Descrição</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        data.forEach(tabela => {
                            // OBS: Certifique-se de que sua view 'api_search_antt' retorna 'id', 'codTabelaANTT' e 'Descricao'
                            html += `
                                <tr>
                                    <td>${tabela.codTabelaANTT}</td>
                                    <td>${tabela.Descricao}</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="selectAntt(${tabela.id}, '${tabela.codTabelaANTT}', '${tabela.Descricao}')">
                                            Selecionar
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        html += `</tbody></table>`;
                    }
                    anttResultsContainer.innerHTML = html;
                })
                .catch(error => {
                    anttResultsContainer.innerHTML = '<p class="text-danger text-center">Erro ao buscar tabelas ANTT.</p>';
                    console.error('Fetch error:', error);
                });

        }, 300);
    }

    // 4 Lógica de Seleção da Tabela ANTT
    function selectAntt(id, cod, descricao) {
    //debugger
    console.log("ANTT SELECIONADA - ID:", id, "Código:", cod);
    
    // 1. Preenche o campo hidden com o ID (para submissão do form)
    anttHiddenId.value = id;
    anttHiddenId.dispatchEvent(new Event('change'));
    
    // 2. Preenche o campo de exibição
    anttDisplay.textContent = `Tabela Selecionada: ${cod} - ${descricao}`;
    
    // 3. Limpa a área de busca/resultados
    anttInput.value = descricao; // Coloca a descrição no campo de busca
    anttResultsContainer.innerHTML = '';
    
    // --- DEBUG EXTRA ---
    console.log("ID Hidden (Valor Final):", anttHiddenId.value);
    // --- DEBUG EXTRA ---
}

</script>
{% endblock %}